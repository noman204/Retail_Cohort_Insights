CREATE DATABASE SALES;
USE DATABASE SALES;
CREATE SCHEMA COHORT_ANALYSIS;
USE SCHEMA  COHORT_ANALYSIS;

CREATE OR REPLACE TABLE RETAIL (
    InvoiceNo varchar (10),
    StockCode varchar (20),
    Description varchar (200),
    Quantity number (8,2),
    InvoiceDate varchar (30),
    Unitprice number (8,2),
    CustomerID number (10),
    Country varchar (25)
);

--TRUNCATE RETAIL

SELECT * FROM RETAIL
LIMIT 10;

SELECT COUNT(*) FROM RETAIL; -- 22,190 Records

--Cohort analysis with no of customer

WITH CTE1 AS
(SELECT 
    INVOICENO,CUSTOMERID,
    TO_DATE (INVOICEDATE, 'DD/MM/YY  HH24:MI') AS INVOICEDATE,
    ROUND(QUANTITY*UNITPRICE,2)  AS REVENUE
FROM RETAIL
    WHERE CUSTOMERID IS NOT NULL
        AND INVOICENO IS NOT NULL
        AND QUANTITY > 0
        AND UNITPRICE> 0),


CTE2 AS
(SELECT 
    INVOICENO, CUSTOMERID,INVOICEDATE,
    DATE_TRUNC('MONTH',INVOICEDATE) AS PURCHASE_MONTH,
    DATE_TRUNC('MONTH',MIN(INVOICEDATE) OVER (PARTITION BY CUSTOMERID ORDER BY INVOICEDATE)) AS FIRST_PURCHASE_MONTH
FROM CTE1),


CTE3 AS
(SELECT 
    CUSTOMERID,FIRST_PURCHASE_MONTH,
    CONCAT('MONTH_',DATEDIFF('MONTH',FIRST_PURCHASE_MONTH,PURCHASE_MONTH)) AS COHORT_MONTH
FROM CTE2)

SELECT * FROM CTE3
PIVOT(COUNT(CUSTOMERID) FOR COHORT_MONTH IN 
('MONTH_0','MONTH_1','MONTH_2','MONTH_3','MONTH_4','MONTH_5','MONTH_6','MONTH_7','MONTH_8','MONTH_9','MONTH_10','MONTH_11','MONTH_12'))
ORDER BY FIRST_PURCHASE_MONTH;


--Cohory analysis on customer lifetime value

WITH CTE1 AS
(SELECT 
    INVOICENO,CUSTOMERID,
    TO_DATE (INVOICEDATE, 'DD/MM/YY  HH24:MI') AS INVOICEDATE,
    ROUND(QUANTITY*UNITPRICE,2)  AS REVENUE
FROM RETAIL
    WHERE CUSTOMERID IS NOT NULL
        AND INVOICENO IS NOT NULL
        AND QUANTITY > 0
        AND UNITPRICE> 0),

CTE2 AS
(SELECT 
    INVOICENO, CUSTOMERID,INVOICEDATE,
    DATE_TRUNC('MONTH',INVOICEDATE) AS PURCHASE_MONTH,
    DATE_TRUNC('MONTH',MIN(INVOICEDATE) OVER (PARTITION BY CUSTOMERID ORDER BY INVOICEDATE)) AS FIRST_PURCHASE_MONTH, REVENUE
FROM CTE1),

CTE3 AS
(SELECT 
    FIRST_PURCHASE_MONTH,
    CONCAT('MONTH_',DATEDIFF('MONTH',FIRST_PURCHASE_MONTH,PURCHASE_MONTH)) AS COHORT_MONTH,
    ROUND (REVENUE,0) AS REVENUE
FROM CTE2)

SELECT * FROM CTE3
PIVOT(SUM(REVENUE) FOR COHORT_MONTH IN  
('MONTH_0','MONTH_1','MONTH_2','MONTH_3','MONTH_4','MONTH_5','MONTH_6','MONTH_7','MONTH_8','MONTH_9','MONTH_10','MONTH_11','MONTH_12'))
ORDER BY FIRST_PURCHASE_MONTH;






